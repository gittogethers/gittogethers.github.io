<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitTogethers Check-In</title>
    <link rel="icon" href="https://github.githubassets.com/favicons/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js" integrity="sha512-YUkaLm+KJ5lQXDBdqBqk7EVhJAdxRnVdT2vtCzwPHSweCzyMgYV/tgGF4/dCyqtCC2eCphz0lRQgatGVdfR0ww==" crossorigin="anonymous"></script>
</head>
<body>
    <main class="container homepage">
        <div class="content">
            <header class="header-content">
                <div class="logo">
                    <img src="https://avatars.githubusercontent.com/u/98106734?s=200&v=4" alt="Logo" class="logo-image">
                </div>
                <p class="tagline" id="event-name"></p>
                <h1>Welcome to this GitTogether!</h1>
            </header>

            <div class="form-container">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="github-username" 
                        placeholder="Enter your GitHub Username"
                        aria-label="GitHub Username"
                        aria-required="true"
                        aria-describedby="error-message">
                </div>
                <button id="proceed-button" aria-label="Submit GitHub username">Proceed</button>
                <p class="error-message" id="error-message" role="alert" aria-live="polite"></p>

                <form action="https://docs.google.com/forms/d/e/1FAIpQLScZHTJnprfPudGnGZe8yL9VbM4XRw5NGlpy9V_IR1rgqCZHcA/formResponse"
                    target="_self"
                    id="bootstrapForm"
                    method="POST"
                    style="display:none;">

                    <!-- Hidden fields for GitHub info -->
                    <input type="hidden" id="846479285" name="entry.846479285">
                    <input type="hidden" id="766830585" name="entry.766830585">
                    <input type="hidden" id="2076383007" name="entry.2076383007">

                    <input type="hidden" name="fvv" value="1">
                    <input type="hidden" name="fbzx" value="-1234567890">
                    <input type="hidden" name="pageHistory" value="0">

                    <input class="btn btn-primary" type="submit" value="Check-In Now">
                </form>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Rate limiting implementation
            const rateLimiter = {
                lastCall: 0,
                minInterval: 1000, // 1 second between calls
                async throttle(fn) {
                    const now = Date.now();
                    const timeToWait = Math.max(0, this.lastCall + this.minInterval - now);
                    
                    if (timeToWait > 0) {
                        await new Promise(resolve => setTimeout(resolve, timeToWait));
                    }
                    
                    try {
                        const result = await fn();
                        this.lastCall = Date.now(); // Update after successful execution
                        return result;
                    } catch (error) {
                        // Don't update lastCall on error to allow immediate retry
                        throw error;
                    }
                }
            };

            let config = null;
            let userData = null;

            // Load config
            const loadConfig = async () => {
                try {
                    const response = await fetch('config.yml');
                    const yamlText = await response.text();
                    config = jsyaml.load(yamlText);
                    return config;
                } catch (error) {
                    console.error('Error loading config:', error);
                    return null;
                }
            };

            // Create mosaic background
            const createMosaicBackground = async () => {
                try {
                    const mosaicContainer = document.createElement('div');
                    mosaicContainer.className = 'background-mosaic';
                    document.body.insertBefore(mosaicContainer, document.body.firstChild);

                    // Check localStorage first
                    const cachedImages = localStorage.getItem('mosaicImages');
                    let images;
                    
                    if (cachedImages) {
                        images = JSON.parse(cachedImages);
                    } else {
                        images = config.background_images;
                        localStorage.setItem('mosaicImages', JSON.stringify(images));
                    }

                    // Shuffle and select only 9 images
                    const shuffledImages = [...images]
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 9);

                    // Load all images first
                    const imageLoadPromises = shuffledImages.map(src => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = () => resolve(img);
                            img.onerror = reject;
                            img.src = src;
                        });
                    });

                    // Wait for all images to load
                    const loadedImages = await Promise.all(imageLoadPromises);

                    // Create 9 image elements in a grid
                    loadedImages.forEach((img, i) => {
                        const newImg = document.createElement('img');
                        newImg.src = img.src;
                        newImg.className = 'mosaic-image';
                        newImg.alt = '';
                        mosaicContainer.appendChild(newImg);
                    });

                    // Show the mosaic after everything is ready
                    requestAnimationFrame(() => {
                        mosaicContainer.classList.add('initialized');
                    });

                } catch (error) {
                    console.error('Error loading background images:', error);
                }
            };

            const usernameInput = document.getElementById('github-username');
            const proceedButton = document.getElementById('proceed-button');
            const errorMessage = document.getElementById('error-message');
            const form = document.getElementById('bootstrapForm');
            const headerContent = document.querySelector('.header-content');
            const logoImage = document.querySelector('.logo-image');
            const heading = document.querySelector('h1');

            const setLoading = (isLoading) => {
                if (isLoading) {
                    proceedButton.textContent = 'Pushing to production..';
                    proceedButton.style.opacity = '0.7';
                    proceedButton.disabled = true;
                } else {
                    proceedButton.textContent = 'Proceed';
                    proceedButton.style.opacity = '1';
                    proceedButton.disabled = false;
                }
            };

            const validateGitHubUsername = async (username) => {
                // Basic validation before API call
                if (!/^[a-zA-Z0-9](?:[a-zA-Z0-9]|-(?=[a-zA-Z0-9])){0,38}$/.test(username)) {
                    throw new Error('Invalid username format');
                }
                
                return rateLimiter.throttle(async () => {
                    const response = await fetch(`https://api.github.com/users/${username}`);
                    if (response.status === 404) {
                        throw new Error('Username not found');
                    } else if (!response.ok) {
                        throw new Error('GitHub API error');
                    }
                    return response.json();
                });
            };

            const showThankYouMessage = () => {
                const content = document.querySelector('.content');
                const userName = document.getElementById('766830585').value;
                const firstName = userName.split(' ')[0];
                
                content.innerHTML = `
                    <div class="thank-you-screen">
                        <div class="thank-you-message">
                            ${config.gittogethers.checkin_thank_you_message.replace('{firstName}', firstName)}
                        </div>
                    </div>
                `;
            };

            const handleSubmit = async (event) => {
                event?.preventDefault();
                
                const username = usernameInput.value.trim();
                errorMessage.textContent = '';
                usernameInput.classList.remove('error');
                
                if (!username) {
                    showInputError('Please enter your GitHub username');
                    return;
                }

                try {
                    userData = await validateGitHubUsername(username);
                    setLoading(true);

                    // Set form values
                    document.getElementById('846479285').value = userData.login;
                    document.getElementById('766830585').value = userData.name || userData.login;
                    document.getElementById('2076383007').value = eventName;

                    // Use jQuery form plugin for submission
                    $('#bootstrapForm').ajaxSubmit({
                        url: form.action,
                        type: 'POST',
                        dataType: 'xml',
                        success: function(response) {
                            showThankYouMessage();
                        },
                        error: function() {
                            showThankYouMessage();
                        }
                    });

                    return true;
                } catch (error) {
                    console.error('Error:', error);
                    showInputError('Invalid GitHub username');
                    return false;
                } finally {
                    setLoading(false);
                }
            };

            // Add input event listener to clear error state
            usernameInput.addEventListener('input', () => {
                usernameInput.classList.remove('error');
                errorMessage.textContent = '';
            });

            // Add this new function for handling input errors
            const showInputError = (message) => {
                const input = document.getElementById('github-username');
                const originalPlaceholder = input.placeholder;
                
                input.classList.add('error');
                input.value = '';
                input.placeholder = message;
                
                // Reset the input state after animation
                setTimeout(() => {
                    input.classList.remove('error');
                    input.placeholder = originalPlaceholder;
                }, 2000);
            };

            // Get event name from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const eventName = urlParams.get('event');
            
            if (!eventName) {
                window.location.href = 'index.html';
                return;
            }

            // Set event name in the tagline
            document.getElementById('event-name').textContent = eventName;

            // Event Listeners
            proceedButton.addEventListener('click', handleSubmit);
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSubmit(e);
                }
            });

            // Initialize
            (async () => {
                await loadConfig();
                createMosaicBackground();
            })();
        });
    </script>
</body>
</html>
