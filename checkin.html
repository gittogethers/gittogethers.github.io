<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitTogethers Check-In</title>
    <link rel="icon" href="https://github.githubassets.com/favicons/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js" integrity="sha512-YUkaLm+KJ5lQXDBdqBqk7EVhJAdxRnVdT2vtCzwPHSweCzyMgYV/tgGF4/dCyqtCC2eCphz0lRQgatGVdfR0ww==" crossorigin="anonymous"></script>
</head>
<body>
    <main class="container homepage">
        <div class="content">
            <header class="header-content">
                <div class="logo">
                    <img src="https://avatars.githubusercontent.com/u/98106734?s=200&v=4" alt="Logo" class="logo-image">
                </div>
                <p class="tagline" id="event-name"></p>
                <h1>Welcome to this GitTogether!</h1>
            </header>

            <div class="form-container">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="github-username" 
                        placeholder="Enter your GitHub Username"
                        aria-label="GitHub Username"
                        aria-required="true"
                        aria-describedby="error-message">
                </div>
                <button id="proceed-button" aria-label="Submit GitHub username">Proceed</button>
                <p class="error-message" id="error-message" role="alert" aria-live="polite"></p>

                <div id="checkin-section" style="display:none;" class="fade-in">
                    <div id="event-selection" style="display:none;">
                        <fieldset>
                            <legend>Which GitTogether you'd like to join?</legend>
                            <div class="form-group">
                                <!-- Events will be populated dynamically from config.yml -->
                            </div>
                        </fieldset>
                    </div>

                    <form action="https://docs.google.com/forms/d/e/1FAIpQLScZHTJnprfPudGnGZe8yL9VbM4XRw5NGlpy9V_IR1rgqCZHcA/formResponse"
                        target="_self"
                        id="bootstrapForm"
                        method="POST">

                        <!-- Hidden fields for GitHub info -->
                        <input type="hidden" id="846479285" name="entry.846479285">
                        <input type="hidden" id="766830585" name="entry.766830585">
                        <input type="hidden" id="2076383007" name="entry.2076383007">

                        <input type="hidden" name="fvv" value="1">
                        <input type="hidden" name="fbzx" value="-1234567890">
                        <input type="hidden" name="pageHistory" value="0">

                        <input class="btn btn-primary" type="submit" value="Check-In Now">
                    </form>
                </div>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Rate limiting implementation
            const rateLimiter = {
                lastCall: 0,
                minInterval: 1000, // 1 second between calls
                async throttle(fn) {
                    const now = Date.now();
                    const timeToWait = Math.max(0, this.lastCall + this.minInterval - now);
                    
                    if (timeToWait > 0) {
                        await new Promise(resolve => setTimeout(resolve, timeToWait));
                    }
                    
                    try {
                        const result = await fn();
                        this.lastCall = Date.now(); // Update after successful execution
                        return result;
                    } catch (error) {
                        // Don't update lastCall on error to allow immediate retry
                        throw error;
                    }
                }
            };

            let config = null;
            let userData = null;

            // Load config
            const loadConfig = async () => {
                try {
                    const response = await fetch('config.yml');
                    const yamlText = await response.text();
                    config = jsyaml.load(yamlText);
                    return config;
                } catch (error) {
                    console.error('Error loading config:', error);
                    return null;
                }
            };

            // Create mosaic background
            const createMosaicBackground = async () => {
                try {
                    const mosaicContainer = document.createElement('div');
                    mosaicContainer.className = 'background-mosaic';
                    document.body.insertBefore(mosaicContainer, document.body.firstChild);

                    // Check localStorage first
                    const cachedImages = localStorage.getItem('mosaicImages');
                    let images;
                    
                    if (cachedImages) {
                        images = JSON.parse(cachedImages);
                    } else {
                        images = config.background_images;
                        localStorage.setItem('mosaicImages', JSON.stringify(images));
                    }

                    // Shuffle and select only 9 images
                    const shuffledImages = [...images]
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 9);

                    // Load all images first
                    const imageLoadPromises = shuffledImages.map(src => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = () => resolve(img);
                            img.onerror = reject;
                            img.src = src;
                        });
                    });

                    // Wait for all images to load
                    const loadedImages = await Promise.all(imageLoadPromises);

                    // Create 9 image elements in a grid
                    loadedImages.forEach((img, i) => {
                        const newImg = document.createElement('img');
                        newImg.src = img.src;
                        newImg.className = 'mosaic-image';
                        newImg.alt = '';
                        mosaicContainer.appendChild(newImg);
                    });

                    // Show the mosaic after everything is ready
                    requestAnimationFrame(() => {
                        mosaicContainer.classList.add('initialized');
                    });

                } catch (error) {
                    console.error('Error loading background images:', error);
                }
            };

            const populateGitTogetherChoices = () => {
                const formGroup = document.querySelector('#event-selection .form-group');
                formGroup.innerHTML = '';
                
                if (config && config.gittogethers) {
                    let hasActiveEvents = false;
                    
                    // Add radio buttons for each event
                    if (config.gittogethers.upcoming && config.gittogethers.upcoming.length > 0) {
                        const now = new Date();
                        config.gittogethers.upcoming.forEach(event => {
                            const endTime = new Date(event.end_time);
                            
                            // Only show events that haven't ended
                            if (now <= endTime) {
                                hasActiveEvents = true;
                                const div = document.createElement('div');
                                div.className = 'radio';
                                div.innerHTML = `
                                    <label>
                                        <input type="radio" name="selected_event" value="${event.name}" required>
                                        ${event.name}
                                    </label>
                                `;
                                formGroup.appendChild(div);
                            }
                        });
                    }

                    if (!hasActiveEvents) {
                        const content = document.querySelector('.content');
                        content.innerHTML = `<div class="thank-you-message">${config.gittogethers.no_events_message}</div>`;
                        document.getElementById('checkin-section').style.display = 'none';
                    }
                }
            };

            const usernameInput = document.getElementById('github-username');
            const proceedButton = document.getElementById('proceed-button');
            const errorMessage = document.getElementById('error-message');
            const form = document.getElementById('bootstrapForm');
            const headerContent = document.querySelector('.header-content');
            const logoImage = document.querySelector('.logo-image');
            const heading = document.querySelector('h1');
            const checkinSection = document.getElementById('checkin-section');
            const eventSelection = document.getElementById('event-selection');

            const setLoading = (isLoading) => {
                if (isLoading) {
                    proceedButton.textContent = 'Pushing to production..';
                    proceedButton.style.opacity = '0.7';
                    proceedButton.disabled = true;
                } else {
                    proceedButton.textContent = 'Proceed';
                    proceedButton.style.opacity = '1';
                    proceedButton.disabled = false;
                }
            };

            const validateGitHubUsername = async (username) => {
                // Basic validation before API call
                if (!/^[a-zA-Z0-9](?:[a-zA-Z0-9]|-(?=[a-zA-Z0-9])){0,38}$/.test(username)) {
                    throw new Error('Invalid username format');
                }
                
                return rateLimiter.throttle(async () => {
                    const response = await fetch(`https://api.github.com/users/${username}`);
                    if (response.status === 404) {
                        throw new Error('Username not found');
                    } else if (!response.ok) {
                        throw new Error('GitHub API error');
                    }
                    return response.json();
                });
            };

            const showThankYouMessage = () => {
                const content = document.querySelector('.content');
                const userName = document.getElementById('766830585').value;
                const firstName = userName.split(' ')[0];
                const githubUsername = document.getElementById('846479285').value;
                const today = new Date().toISOString().split('T')[0];
                
                content.innerHTML = `
                    <div class="thank-you-screen">
                        <div class="skyline-container loading">
                            <img src="https://avatars.githubusercontent.com/u/98106734?s=200&v=4" alt="Logo" style="display: none;">
                        </div>
                        <div class="thank-you-message">
                            ${config.gittogethers.checkin_thank_you_message.replace('{firstName}', firstName)}
                        </div>
                        <div class="thank-you-buttons">
                            ${config.thank_you_buttons.map(button => 
                                `<a href="${button.url}" target="_blank" rel="noopener noreferrer" title="${button.text}">${button.text}</a>`
                            ).join('')}
                        </div>
                    </div>
                `;

                // Only show skyline if user has repos
                if (userData?.public_repos > 0) {
                    const skylineContainer = content.querySelector('.skyline-container');
                    const fallbackImage = skylineContainer.querySelector('img');
                    const iframe = document.createElement('iframe');
                    
                    iframe.src = `https://skyline3d.in/${githubUsername}/embed?endDate=${today}&enableZoom=true`;
                    iframe.width = '100%';
                    iframe.height = '100%';
                    iframe.frameBorder = '0';
                    iframe.title = 'GitHub Skyline';
                    iframe.style.display = 'none';
                    
                    // Show skyline only when loaded
                    iframe.onload = () => {
                        requestAnimationFrame(() => {
                            skylineContainer.classList.remove('loading');
                            fallbackImage.style.display = 'none';
                            iframe.style.display = 'block';
                        });
                    };
                    
                    // Show fallback on error or if loading takes too long
                    iframe.onerror = () => {
                        skylineContainer.classList.remove('loading');
                        fallbackImage.style.display = 'block';
                        iframe.remove();
                    };

                    // Fallback if loading takes too long
                    setTimeout(() => {
                        if (skylineContainer.classList.contains('loading')) {
                            skylineContainer.classList.remove('loading');
                            fallbackImage.style.display = 'block';
                            iframe.remove();
                        }
                    }, 10000); // 10 seconds timeout
                    
                    skylineContainer.appendChild(iframe);
                } else {
                    // Show app avatar for users with no repos
                    const skylineContainer = content.querySelector('.skyline-container');
                    const fallbackImage = skylineContainer.querySelector('img');
                    skylineContainer.classList.remove('loading');
                    fallbackImage.style.display = 'block';
                }
            };

            const handleSubmit = async (event) => {
                event?.preventDefault();
                
                const username = usernameInput.value.trim();
                errorMessage.textContent = '';
                usernameInput.classList.remove('error');
                
                if (!username) {
                    showInputError('Please enter your GitHub username');
                    return;
                }

                try {
                    userData = await validateGitHubUsername(username);
                    setLoading(true);

                    // Update UI
                    logoImage.src = userData.avatar_url;
                    const displayName = userData.name || userData.login;
                    heading.innerHTML = `Hello<span class="editable-name">${displayName}</span> 👋`;
                    headerContent.classList.add('compact');

                    // Add name edit links
                    const nameEditLinks = document.createElement('div');
                    nameEditLinks.className = 'name-edit-links';
                    nameEditLinks.innerHTML = `
                        <a href="#" class="not-you-link">Not you?</a>
                        <a href="#" class="edit-name-link">Edit Name</a>
                    `;
                    heading.insertAdjacentElement('afterend', nameEditLinks);

                    // Add event listeners for name editing
                    const editableNameSpan = heading.querySelector('.editable-name');
                    const editNameLink = nameEditLinks.querySelector('.edit-name-link');
                    const notYouLink = nameEditLinks.querySelector('.not-you-link');
                    let originalName = displayName;
                    editableNameSpan.setAttribute('data-original-name', originalName);

                    const cancelNameEdit = () => {
                        editableNameSpan.textContent = originalName;
                        editableNameSpan.contentEditable = false;
                        editableNameSpan.classList.remove('editing');
                        editNameLink.textContent = 'Edit Name';
                    };

                    const saveNameEdit = () => {
                        const newName = editableNameSpan.textContent.trim();
                        if (newName) {
                            originalName = newName;
                            editableNameSpan.contentEditable = false;
                            editableNameSpan.classList.remove('editing');
                            editNameLink.textContent = 'Edit Name';
                            document.getElementById('766830585').value = originalName;
                            editableNameSpan.setAttribute('data-original-name', originalName);
                            editableNameSpan.textContent = originalName;
                        } else {
                            cancelNameEdit();
                        }
                    };

                    editableNameSpan.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (editNameLink.textContent === 'Save') {
                                saveNameEdit();
                            }
                        } else if (e.key === 'Escape') {
                            cancelNameEdit();
                        }
                    });

                    editNameLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (editNameLink.textContent === 'Edit Name') {
                            editableNameSpan.contentEditable = true;
                            editableNameSpan.classList.add('editing');
                            editableNameSpan.focus();
                            const range = document.createRange();
                            range.selectNodeContents(editableNameSpan);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                            editNameLink.textContent = 'Save';
                        } else {
                            saveNameEdit();
                        }
                    });

                    editableNameSpan.addEventListener('blur', (e) => {
                        requestAnimationFrame(() => {
                            const activeElement = document.activeElement;
                            if (editNameLink.textContent === 'Save' && 
                                !activeElement?.closest('.name-edit-links') && 
                                activeElement !== editableNameSpan) {
                                cancelNameEdit();
                            }
                        });
                    });

                    notYouLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        location.reload();
                    });

                    // Hide username input and proceed button
                    usernameInput.parentElement.style.display = 'none';
                    proceedButton.style.display = 'none';

                    // Set form values
                    document.getElementById('846479285').value = userData.login;
                    document.getElementById('766830585').value = displayName;

                    // Show check-in section
                    checkinSection.style.display = 'block';

                    // Handle event selection
                    const urlParams = new URLSearchParams(window.location.search);
                    const eventParam = urlParams.get('event');
                    
                    if (eventParam && config.gittogethers.upcoming.some(e => e.name === eventParam)) {
                        document.getElementById('2076383007').value = eventParam;
                        document.getElementById('event-name').textContent = eventParam;
                    } else {
                        eventSelection.style.display = 'block';
                        populateGitTogetherChoices();
                        
                        // Add event listener for radio buttons
                        document.querySelectorAll('input[name="selected_event"]').forEach(radio => {
                            radio.addEventListener('change', () => {
                                document.getElementById('2076383007').value = radio.value;
                                document.getElementById('event-name').textContent = radio.value;
                            });
                        });
                    }

                    // Add form submit handler
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        // Validate event selection if needed
                        if (eventSelection.style.display !== 'none') {
                            const selectedEvent = document.querySelector('input[name="selected_event"]:checked');
                            if (!selectedEvent) {
                                const formGroup = document.querySelector('#event-selection .form-group');
                                showRadioError(formGroup, 'Please select an event');
                                return;
                            }
                        }

                        // Submit form
                        $('#bootstrapForm').ajaxSubmit({
                            url: form.action,
                            type: 'POST',
                            dataType: 'xml',
                            success: function(response) {
                                showThankYouMessage();
                            },
                            error: function() {
                                showThankYouMessage();
                            }
                        });
                    });

                    return true;
                } catch (error) {
                    console.error('Error:', error);
                    showInputError('Invalid GitHub username');
                    return false;
                } finally {
                    setLoading(false);
                }
            };

            // Add input event listener to clear error state
            usernameInput.addEventListener('input', () => {
                usernameInput.classList.remove('error');
                errorMessage.textContent = '';
            });

            // Add this new function for handling input errors
            const showInputError = (message) => {
                const input = document.getElementById('github-username');
                const originalPlaceholder = input.placeholder;
                
                input.classList.add('error');
                input.value = '';
                input.placeholder = message;
                
                // Reset the input state after animation
                setTimeout(() => {
                    input.classList.remove('error');
                    input.placeholder = originalPlaceholder;
                }, 2000);
            };

            const showRadioError = (container, message) => {
                let errorDiv = container.querySelector('.radio-error-message');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'radio-error-message';
                    container.appendChild(errorDiv);
                }
                errorDiv.textContent = message;
                errorDiv.classList.add('show');

                if (window.innerWidth <= 768) {
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };

            // Event Listeners
            proceedButton.addEventListener('click', handleSubmit);
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSubmit(e);
                }
            });

            // Initialize
            (async () => {
                await loadConfig();
                createMosaicBackground();
            })();
        });
    </script>
</body>
</html>
